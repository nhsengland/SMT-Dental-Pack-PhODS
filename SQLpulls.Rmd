---
title: "SQL pulls for SMT Dental Pack"
---
```{r}
library(tidyverse)
library(readxl)
library(DBI)
library(odbc)
library(downloadthis)
library(lubridate)
```

```{r working days}

#read local file -- No working days in each month
working_days <- read_excel("N:/_Everyone/Primary Care Group/SMT_Dental DENT 2022_23-008/workdays.xlsx",sheet = "workdays")
working_days$month<- as.Date(working_days$Month)

```

```{r contractors}

#extract contractual_dataset from NCDR
pull_contractual_dataset <- function(){
  
  con <- dbConnect(odbc::odbc(), "NCDR")
  
  sql <- "SELECT [YEAR_MONTH],
                [CONTRACT_NUMBER]
  FROM [NHSE_Sandbox_PrimaryCareNHSContracts].[Dental].[contractual_dataset]
  where [YEAR_MONTH] > '2016-03-01'"
  result <- dbSendQuery(con, sql)
  contractual_dataset <- dbFetch(result)
  dbClearResult(result)
  
  contractual_dataset
}

#remove duplicates
contractual_dataset<-pull_contractual_dataset()%>%
    mutate(YEAR_MONTH = as.Date(YEAR_MONTH))%>% 
  group_by(YEAR_MONTH) %>% summarize(CONTRACT_NUMBER = unique(CONTRACT_NUMBER))


```



```{r UDA}

#extract UDA calendar data
pull_UDA_calendar_data <- function(){
  
  con <- dbConnect(odbc::odbc(), "NCDR")
  
  sql <- "SELECT *
  FROM [NHSE_Sandbox_PrimaryCareNHSContracts].[Dental].[general_dental_activity]
  where [YEAR_MONTH] > '2016-03-01'"
  result <- dbSendQuery(con, sql)
  UDA_calendar_data <- dbFetch(result)
  dbClearResult(result)
  
  UDA_calendar_data
}

#only include contractors in contractual_dataset
UDA_calendar_data<-pull_UDA_calendar_data()%>%
  inner_join(contractual_dataset,by=c('YEAR_MONTH','CONTRACT_NUMBER'))
#exclude those with UDA target less than 1 - rename fields
UDA_calendar_data = dplyr::filter(UDA_calendar_data, as.numeric(UDA_PERF_TARGET) > 1.0)
names(UDA_calendar_data) <- base::tolower(names(UDA_calendar_data))
UDA_calendar_data<-UDA_calendar_data%>%
  rename(month=year_month,annual_contracted_UDA=uda_perf_target,UDA_delivered=uda_delivered,commissioner_ods_code_icb=commissioner_code,name_or_company_name=provider_name,FP17s_band_1=band_1_delivered,FP17s_band_2=band_2_delivered,FP17s_band_2a=band_2a_delivered,FP17s_band_2b=band_2b_delivered,FP17s_band_2c=band_2c_delivered,FP17s_band_3=band_3_delivered,FP17s_band_urgent=band_urgent_delivered,FP17s_band_other=band_other_delivered,UDA_band_1=uda_band_1_delivered,UDA_band_2=uda_band_2_delivered,UDA_band_3=uda_band_3_delivered,UDA_urgent=uda_band_urgent_delivered,UDA_other=uda_band_other_delivered) %>% 
  rowwise() %>% 
  mutate(FP17s_band_2 = sum(FP17s_band_2, FP17s_band_2a, FP17s_band_2b, FP17s_band_2c, na.rm = T))

UDA_calendar_data$region_name<- str_to_title(UDA_calendar_data$region_name)

```


```{r UOA}

pull_UOA_calendar_data <- function(){
  
  con <- dbConnect(odbc::odbc(), "NCDR")
  
  sql <- "SELECT *
  FROM [NHSE_Sandbox_PrimaryCareNHSContracts].[Dental].[orthodontic_activity]
  where [Year_Month] > '2016-03-01'"
  result <- dbSendQuery(con, sql)
  UOA_calendar_data <- dbFetch(result)
  dbClearResult(result)
  
  UOA_calendar_data
}

UOA_calendar_data<-pull_UOA_calendar_data()
#only include contractors in contractual_dataset and exclude those with UOA target less than 1 - rename fields
UOA_calendar_data = dplyr::filter(UOA_calendar_data, as.numeric(UOA_PERF_TAR) > 1.0)
UOA_calendar_data<-UOA_calendar_data%>%
  inner_join(contractual_dataset,by=c('YEAR_MONTH','CONTRACT_NUMBER'))
names(UOA_calendar_data) <- base::tolower(names(UOA_calendar_data))
UOA_calendar_data<-UOA_calendar_data%>%
  rename(month=year_month,commissioner_ods_code_icb=commissioner_code,name_or_company_name=provider_name,annual_contracted_UOA=uoa_perf_tar,UOA_delivered=uoa_delivered,orthodontic_starts=ortho_trt_started,orthodontic_completions=ortho_trt_completed)

UOA_calendar_data$region_name<- str_to_title(UOA_calendar_data$region_name)

```



```{r dental 111 data}
#get dental 111 data from local file
dental_data_111 <- read_excel("N:/_Everyone/Primary Care Group/SMT_Dental DENT 2022_23-008/111_pathways_data/dental_data_111.xlsx")
```

