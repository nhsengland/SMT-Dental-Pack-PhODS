---
title: "plotting for SMT Dental Pack"
---

```{r packages}

library(ggrepel)

```

```{r get colour palette}
get_colour_palette <- function(){
  
  # The palette with grey:
  c("#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#CC79A7","#F0E442",  "#999999")
  
}
```


```{r UDA/UOA %delivered/contracted - standardised by working days without historical data}

plot_UDA_UOA_delivery_wd <- function(data = UDA_calendar_data, 
                                     UDAorUOA = "UDA",
                                     level = "National",
                                     region_STP_name = NULL,
                                     plotChart = TRUE, 
                                     all_regions_and_STPs = FALSE){
  
  #filter for STP or region-- select the STP or region you want
  if(level == "Regional"){
    data <- data %>%
      filter(region_name == region_STP_name )
    subtitle <- region_STP_name
  }else if(level == "STP"){
    data <- data %>%
      filter(commissioner_name == region_STP_name)
    subtitle <- region_STP_name
  }else{
    subtitle <- "England"
  }
  
  if(UDAorUOA == "UDA"){
    #get data into the right format if this is for UDA
    data <- get_delivery_data(data = data, UDAorUOA = "UDA", all_regions_and_STPs =all_regions_and_STPs)
    
    #set title and ylab and target of percentage of UDA delivered for each quarter
    title <- "monthly percentage of usual annual contracted UDAs \nsubmitted across all contracts standardised by working days"
    ylab <- "% of contracted UDAs submitted"
    #captionTitle <- "*These are treatment months."
    
    lineCol <- "#CC79A7"
  #  septemberTarget <- 60
  #  decemberTarget <- 65
  #  marchTarget <- 85
  #  juneTarget <- 95
    
    #method 1-- function to calculate the number of working days -- you can use it if you want
#    Nweekdays <- function(a, b, holidays, weekend) { 
#    possible_days <- seq(a, b, "days")
  # Count all days that are not weekend and
  # are not holidays
#    sum(!weekdays(possible_days) %in% weekend & !possible_days %in% holidays)
#    }

#    weekend <-  c("Saturday", "Sunday")
#    holidays <- as.Date(c("2023-04-07", "2023-04-10", "2023-05-01",'2023-08-28', '2023-12-25','2023-12-26', '2024-01-01', '2024-03-29', '2024-04-01', '2024-05-06', '2024-08-26', '2024-12-25','2024-12-26','2025-01-01'))
#    Nweekdays(as.Date("2017-08-01"), as.Date("2017-12-31"), holidays, weekend)
    

#method 2 -- to calculate percentage of delivered UDA standardised by no of working days
    data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`)))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
    
    
    
  }else{
    #get data into the right format if this is for UOA
    data <- get_delivery_data(data = data, UDAorUOA = "UOA", all_regions_and_STPs = F)
    title <- "monthly percentage of usual annual contracted UOAs \nsubmitted across all contracts standardised by working days"
    ylab <- "% of contracted UOAs submitted"
    #captionTitle <- "**These are treatment months.."
    lineCol <- "steelblue"
   # septemberTarget <- 80
   # decemberTarget <- 85
   # marchTarget <- 90
  #  juneTarget <- 100
    
    #to calculate percentage of delivered UOA standardized by no of working days
    data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`)))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
  }
  
  data <- data %>%
    mutate(month = as.Date(month))
  
  if(plotChart == TRUE){
    #plot code
    p <- ggplot(data) +
      theme_bw() +
      #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      #geom_line(aes(x = month,
      #              y = perc_UDA_UOA_delivered),
      #          colour = lineCol,
      #          linewidth = 1) +
      geom_line(aes(x = month,
                    y = perc_standardised_wd),
                colour = "blue",
                linewidth = 1) +
      geom_point(aes(x = month,
                     y = perc_standardised_wd),
                 colour = lineCol
      ) 
    
      
      p <- p +
       # geom_segment(aes(x = as.Date("2021-04-01"), y = septemberTarget, xend = as.Date("2021-09-01"), yend = septemberTarget),
       #              colour = "#0072B2",
       #              linetype = "dashed") +
       # geom_segment(aes(x = as.Date("2021-10-01"), y = decemberTarget, xend = as.Date("2021-12-01"), yend = decemberTarget),
       #              colour = "#0072B2",
       #              linetype = "dashed") +
       # geom_segment(aes(x = as.Date("2022-01-01"), y = marchTarget, xend = as.Date("2022-03-01"), yend = marchTarget),
       #             colour = "#0072B2",
       #              linetype = "dashed") +
       # geom_segment(aes(x = as.Date("2022-04-01"), y = juneTarget, xend = as.Date("2022-06-01"), yend = juneTarget),
       #              colour = "#0072B2",
        #             linetype = "dashed") +
       # 
       # annotate(geom = "text",
       #          x = as.Date("2021-04-01") + lubridate::weeks(2),
       #          y = septemberTarget - 5,
       #          label = "H1 threshold",
       #          size = 3,
        #         colour = "#0072B2") +
        #annotate(geom = "text",
        #         x = as.Date("2021-10-01") + lubridate::weeks(2),
        #         y = decemberTarget - 5,
        #         label = "Q3 threshold",
        #         size = 3,
        #         colour = "#0072B2") +
       # annotate(geom = "text",
       #          x = as.Date("2022-01-01") + lubridate::weeks(2),
       #          y = marchTarget - 5,
       #          label = "Q4 threshold",
       #          size = 3,
       #          colour = "#0072B2") +
       # annotate(geom = "text",
       #          x = as.Date("2022-04-01") + lubridate::weeks(2),
       #          y = juneTarget - 5,
       #          label = "Q1 threshold",
       #          size = 3,
        #         colour = "#0072B2") +
        
       # annotate(geom = "text",
       #          x = data$month,
       #          y = data$perc_UDA_UOA_delivered + 5,
       #          label = paste0(data$perc_UDA_UOA_delivered, "%"),
       #          ##paste0(data$perc_standardised_wd [nrow(data)], "%")
       #          size = 3) +
        annotate(geom = "text",
                 x = data$month,
                 y = data$perc_standardised_wd - 3,
                 label = paste0(data$perc_standardised_wd, "%"),
                 size = 3,
                 color="blue")
      

    
    p <- p +
      scale_x_date(date_breaks = "1 month",
                   date_labels = "%b-%y") +
      scale_y_continuous(limits = c(0, max(c(data$perc_standardised_wd, 95), na.rm = T) + 5),
                         breaks = seq(0, max(c(data$perc_standardised_wd, 95), na.rm = T) + 5, 10)) +
      labs(title = title,
           x = "Month",
           y = ylab,
           subtitle = subtitle) +
      theme(axis.text.x = element_text(angle = 90, vjust=-0.0001
      ))
    
    p
    
  }else{
    #what if plotChart == FALSE -- want to create a table instead of a plot
    if(UDAorUOA == "UDA"){
      new_col_names <- c(`Calendar month` = "month",
                         `Region Name` = "region_name",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UDAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UDAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UDAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UDAs delivered` = "perc_standardised_wd")
    }else{
      new_col_names <- c(`Calendar month` = "month",
                         `Region Name` = "region_name",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UOAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UOAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UOAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UOAs delivered` = "perc_standardised_wd")
    }
    
    data$`month` <- format(as.Date(data$`month`), "%Y-%m")
    
    #rename columns
    data <- data %>%
      rename(any_of(new_col_names))
  }
}

```


```{r UDA/UOA %delivered/contracted - standardised by working days without historical data -- include all regions}
plot_UDA_UOA_delivery_all_regions <- function(data = UDA_calendar_data, 
                                              UDAorUOA = "UDA",
                                              level = "National",
                                              region_STP_name = NULL,
                                              plotChart = TRUE, 
                                              all_regions_and_STPs = FALSE){
   
  if(UDAorUOA == "UDA"){
     #include data only after 2020-04-01 as there is no region info before that and select fields needed
   data <- data %>%
    mutate(month = as.Date(month))%>%
    filter(month >= as.Date ("2020-04-01"))%>%
      select(month, contract_number, commissioner_name, region_name, 
             annual_contracted_UDA, UDA_delivered)

 
  #get data into the right format and calculate the annual contracted UDA, delivered UDA and percentage of UDA delivered (standardised by no of working days)
 data <- get_delivery_data(data = data, UDAorUOA = "UDA", all_regions_and_STPs = TRUE)
  data <- data%>%filter(month>"2020-03-01")
 
  data <- data %>%
    group_by(month, region_name) %>%
    summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered, na.rm = TRUE),
              annual_contracted_UDA_UOA = sum(annual_contracted_UDA_UOA, na.rm = TRUE)) %>%
    filter(!is.na(region_name))
  
   data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*(monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`))))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
   
  title <- "calendar monthly percentage of usual annual contracted UDAs \nsubmitted across all contracts standardised by working days"
  ylab <- "% of contracted UDAs submitted"
 # captionTitle <- "*These are calendar months and data has been scaled up by 12."
  lineCol <- "coral"
  lineCol <- "#CC79A7"
 # septemberTarget <- 60
 # decemberTarget <- 65
 # marchTarget <- 85
 # juneTarget <- 95
  }else{
     #include data only after 2020-04-01 as there is no region info before that and select fields needed
       data <- data %>%
    mutate(month = as.Date(month))%>%
    filter(month >= as.Date ("2020-04-01"))%>%
      select(month, contract_number, commissioner_name, region_name, 
             annual_contracted_UOA, UOA_delivered)
       
    #get data into the right format and calculate the annual contracted UOA, delivered UOA and percentage of UOA delivered (standardized by no of working days)
 data <- get_delivery_data(data = data, UDAorUOA = "UOA", all_regions_and_STPs = TRUE)
  data <- data%>%filter(month>"2020-03-01")
 
  data <- data %>%
    group_by(month, region_name) %>%
    summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered, na.rm = TRUE),
              annual_contracted_UDA_UOA = sum(annual_contracted_UDA_UOA, na.rm = TRUE)) %>%
    filter(!is.na(region_name))
  
   data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*(monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`))))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
   
  title <- "calendar monthly percentage of usual annual contracted UOAs \nsubmitted across all contracts standardised by working days"
  ylab <- "% of contracted UOAs submitted"
 # captionTitle <- "*These are calendar months and data has been scaled up by 12."
  lineCol <- "coral"
  lineCol <- "#CC79A7"
 # septemberTarget <- 60
 # decemberTarget <- 65
 # marchTarget <- 85
 # juneTarget <- 95
  }   
    
  if(plotChart == TRUE){
    #plot code
    p <- ggplot(data) +
      theme_bw() +
      #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      geom_line(aes(x = month, 
                    y = perc_standardised_wd, 
                    colour = region_name), 
                size = 1) +
      geom_point(aes(x = month, 
                     y = perc_standardised_wd, 
                     colour = region_name)
      ) +
      
      scale_x_date(date_breaks = "1 month", 
                   date_labels = "%b-%y") +
      scale_y_continuous(limits = c(0, max(c(data$perc_standardised_wd, 95), na.rm = T) + 5),
                         breaks = seq(0, max(c(data$perc_standardised_wd, 95), na.rm = T) + 5, 10)) +
      labs(title = title, 
           x = "Month",
           y = ylab, 
           #caption = captionTitle,
           colour = "Region") +
      theme(axis.text.x = element_text(angle = 90, vjust=-0.0001
      ))
    
    p
    
  }else{
   #IF WANT TO GET A DATA TABLE 
    if(UDAorUOA == "UDA"){
      new_col_names <- c(`Calendar month` = "month",
                         `Region Name` = "region_name",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UDAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UDAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UDAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UDAs delivered` = "perc_standardised_wd")
    }else{
      new_col_names <- c(`Calendar month` = "month",
                         `Region Name` = "region_name",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UOAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UOAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UOAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UOAs delivered` = "perc_standardised_wd")
    }
   
    data$`month` <- format(as.Date(data$`month`), "%Y-%m")
    
     data <- data %>%
      rename(any_of(new_col_names))
     
  }
  
}
```


```{r UDA/UOA %delivered/contracted - standardised by working days without historical data -- include all ICBs}
plot_UDA_UOA_delivery_all_ICBs <- function(data = UOA_calendar_data, 
                                              UDAorUOA = "UOA",
                                              plotChart = TRUE,
                                           region_STP_name='London'){
 
  
  
   
  if(UDAorUOA == "UDA"){
     #include data only after 2020-04-01 and select fields needed
    
data <- data %>%
      filter(region_name == region_STP_name)
   data <- data %>%
    mutate(month = as.Date(month))%>%
    filter(month >= as.Date ("2020-04-01"))%>%
      select(month, contract_number, commissioner_name, region_name, 
             annual_contracted_UDA, UDA_delivered)

 
  #get data into the right format and calculate the annual contracted UDA, delivered UDA and percentage of UDA delivered (standardized by working days)
 data <- get_delivery_data(data = data, UDAorUOA = "UDA", all_regions_and_STPs = TRUE)
  data <- data%>%filter(month>"2020-03-01")
 
  data <- data %>%
    group_by(month, region_name,commissioner_name) %>%
    summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered, na.rm = TRUE),
              annual_contracted_UDA_UOA = sum(annual_contracted_UDA_UOA, na.rm = TRUE)) %>%
    filter(!is.na(region_name))
  
   data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*(monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`))))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
   
  title <- "calendar monthly percentage of usual annual contracted UDAs \nsubmitted across all contracts standardised by working days"
  ylab <- "% of contracted UDAs submitted"
 # captionTitle <- "*These are calendar months and data has been scaled up by 12."
  lineCol <- "coral"
  lineCol <- "#CC79A7"
 # septemberTarget <- 60
 # decemberTarget <- 65
 # marchTarget <- 85
 # juneTarget <- 95
  }else{
    #include data only after 2020-04-01 and select fields needed
    data <- data %>%
      filter(region_name == region_STP_name)
       data <- data %>%
    mutate(month = as.Date(month))%>%
    filter(month >= as.Date ("2020-04-01"))%>%
      select(month, contract_number, commissioner_name, region_name, 
             annual_contracted_UOA, UOA_delivered)
       
   #get data into the right format and calculate the annual contracted UOA, delivered UOA and percentage of UOA delivered (standardized by working days)
 data <- get_delivery_data(data = data, UDAorUOA = "UOA", all_regions_and_STPs = TRUE)
  data <- data%>%filter(month>"2020-03-01")
 
  data <- data %>%
    group_by(month, region_name,commissioner_name) %>%
    summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered, na.rm = TRUE),
              annual_contracted_UDA_UOA = sum(annual_contracted_UDA_UOA, na.rm = TRUE)) %>%
    filter(!is.na(region_name))
  
   data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*(monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`))))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
   
  title <- "calendar monthly percentage of usual annual contracted UOAs \nsubmitted across all contracts standardised by working days"
  ylab <- "% of contracted UOAs submitted"
 # captionTitle <- "*These are calendar months and data has been scaled up by 12."
  lineCol <- "coral"
  lineCol <- "#CC79A7"
 # septemberTarget <- 60
 # decemberTarget <- 65
 # marchTarget <- 85
 # juneTarget <- 95
  }   
    
  if(plotChart == TRUE){
    #plot code
    p <- ggplot(data) +
      theme_bw() +
      #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      geom_line(aes(x = month, 
                    y = perc_standardised_wd, 
                    colour = commissioner_name), 
                size = 1) +
      geom_point(aes(x = month, 
                     y = perc_standardised_wd, 
                     colour = commissioner_name)
      ) +
      
      scale_x_date(date_breaks = "1 month", 
                   date_labels = "%b-%y") +
      scale_y_continuous(limits = c(0, max(c(data$perc_standardised_wd, 95), na.rm = T) + 5),
                         breaks = seq(0, max(c(data$perc_standardised_wd, 95), na.rm = T) + 5, 10)) +
      labs(title = title, 
           x = "Month",
           y = ylab, 
           #caption = captionTitle,
           colour = "commissioner_name") +
      theme(axis.text.x = element_text(angle = 90, vjust=-0.0001
      ))
    
    p
    
  }else{
    
    if(UDAorUOA == "UDA"){
      new_col_names <- c(`Calendar month` = "month",
                         `Region Name` = "region_name",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UDAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UDAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UDAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UDAs delivered` = "perc_standardised_wd")
    }else{
      new_col_names <- c(`Calendar month` = "month",
                         `Region Name` = "region_name",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UOAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UOAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UOAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UOAs delivered` = "perc_standardised_wd")
    }
    
    data$`month` <- format(as.Date(data$`month`), "%Y-%m")
    data <- data %>%
      rename(any_of(new_col_names))
  }
  
}

```


```{r UDA/UOA %delivered/contracted - standardised by working days without historical data -- include all ICBs -- table}
Table_UDA_UOA_delivery_all_ICBs <- function(data = UOA_calendar_data, 
                                              UDAorUOA = "UOA"){
 
  
  
   
  if(UDAorUOA == "UDA"){
     #include data only after 2021-04-01 and select fields needed
    
   data <- data %>%
    mutate(month = as.Date(month))%>%
    filter(month >= as.Date ("2020-04-01"))%>%
      select(month, contract_number, commissioner_name, region_name, 
             annual_contracted_UDA, UDA_delivered)

 
  #get data into the right format and calculate the annual contracted UDA, delivered UDA and percentage of UDA delivered
 data <- get_delivery_data(data = data, UDAorUOA = "UDA", all_regions_and_STPs = TRUE)
  data <- data%>%filter(month>"2020-03-01")
 
  data <- data %>%
    group_by(month, commissioner_name) %>%
    summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered, na.rm = TRUE),
              annual_contracted_UDA_UOA = sum(annual_contracted_UDA_UOA, na.rm = TRUE))
  
   data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*(monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`))))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
   #rename columns
   new_col_names <- c(`Calendar month` = "month",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UDAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UDAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UDAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UDAs delivered` = "perc_standardised_wd")
   
  data$`month` <- format(as.Date(data$`month`), "%Y-%m")
   data <- data %>%
      rename(any_of(new_col_names))

   
  }else{
    #do similar things for UOA
       data <- data %>%
    mutate(month = as.Date(month))%>%
    filter(month >= as.Date ("2020-04-01"))%>%
      select(month, contract_number, commissioner_name, region_name, 
             annual_contracted_UOA, UOA_delivered)
       
    #get data into the right format and calculate the annual contracted UDA, delivered UDA and percentage of UDA delivered
 data <- get_delivery_data(data = data, UDAorUOA = "UOA", all_regions_and_STPs = TRUE)
  data <- data%>%filter(month>"2020-03-01")
 
  data <- data %>%
    group_by(month, commissioner_name) %>%
    summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered, na.rm = TRUE),
              annual_contracted_UDA_UOA = sum(annual_contracted_UDA_UOA, na.rm = TRUE))
  
   data <- data %>% left_join(working_days,by=c('month')) %>% 
      mutate(perc_standardised_wd_int = 100*(monthly_UDA_UOAs_delivered /(annual_contracted_UDA_UOA*(`no workdays`/`total workdays`))))%>% 
      mutate(perc_standardised_wd = round(perc_standardised_wd_int, digits = 0))
   
    
      new_col_names <- c(`Calendar month` = "month",
                         `Commissioner Name` = "commissioner_name",
                         `Monthly UOAs delivered` = "monthly_UDA_UOAs_delivered",
                         `Annual contracted UOAs` = "annual_contracted_UDA_UOA",
                         #`Scaled monthly UOAs delivered` = "scaled_monthly_UDA_UOAs_delivered",
                         `Standardised monthly percentage of contracted UOAs delivered` = "perc_standardised_wd")
      
      data$`month` <- format(as.Date(data$`month`), "%Y-%m")
      data <- data %>%
      rename(any_of(new_col_names))

  }   
  
}  


```



```{r number of contract}

get_num_contracts <- function(data = UDA_calendar_data,
                              UDAorUOA = "UDA",
                              level = "National",
                              region_STP_name = NULL){

  
  #filter for STP or region in need
  if(level == "Regional"){
    data <- data %>% 
      filter(region_name == region_STP_name )
  }else if(level == "STP"){
    data <- data %>% 
      filter(commissioner_name == region_STP_name)
    subtitle <- region_STP_name
  }
  
  data <- data %>%
    filter(month == max(data$month))
  #calculate the no of contractors
  nrow(data)
}


```



```{r UDA activity- standardised by working days with historical data}

plot_historic_UDA_delivery_wd <- function(data = UDA_calendar_data,
                                                           level = "National",
                                                           region_STP_name = NULL){
  
  
  
  #filter for STP or region in need
  if(level == "Regional"){
    data <- data %>%
      filter(region_name == region_STP_name )
    
    
    subtitle <- region_STP_name
    
  }else if(level == "STP"){
    data <- data %>%
      filter(commissioner_name == region_STP_name)
    

    subtitle <- region_STP_name
    
  }else{
    subtitle <- "England"
  }
  
  
  #prepare historic data 
  historic_data <- data %>%
    select(month, contract_number, commissioner_name, region_name,
           annual_contracted_UDA, UDA_delivered)
  #create a new field as financial year and then calculate full year UDA delivered, contracted UDA and percentage of UDA delivered
  historic_data <- historic_data  %>%
    mutate(financial_year = case_when(month >= as.Date("2016-04-01") & month < as.Date("2017-04-01") ~ "2016/17",
                                      month >= as.Date("2017-04-01") & month < as.Date("2018-04-01") ~ "2017/18",
                                      month >= as.Date("2018-04-01") & month < as.Date("2019-04-01") ~ "2018/19",
                                      month >= as.Date("2019-04-01") & month < as.Date("2020-04-01") ~ "2019/20",
                                      month >= as.Date("2020-04-01") & month < as.Date("2021-04-01") ~ "2020/21",
                                      month >= as.Date("2021-04-01") & month < as.Date("2022-04-01") ~ "2021/22",
                                      month >= as.Date("2022-04-01") & month < as.Date("2023-04-01") ~ "2022/23",
                                      month >= as.Date("2023-04-01") & month < as.Date("2024-04-01") ~ "2023/24",
                                      month >= as.Date("2024-04-01") & month < as.Date("2025-04-01") ~ "2024/25")) %>%
    group_by(financial_year) %>%
    summarise(full_year_UDA_delivery = sum(UDA_delivered, na.rm = TRUE),
              full_year_contracted_UDAs = sum(annual_contracted_UDA, na.rm = TRUE) / 12) %>%
    mutate(perc_UDA_deliverd = full_year_UDA_delivery * 100 / full_year_contracted_UDAs)
  
  
  
  #get current FY data ready
  # way to calculate percentage of UDA delivered which is standardized by no of working days 
  data_try <- data %>%
    group_by(month) %>%
    summarise(UDA_delivery = sum(UDA_delivered, na.rm = TRUE),
              contracted_UDAs = sum(annual_contracted_UDA, na.rm = TRUE)) %>%
    filter(month >= as.Date ("2023-04-01")) %>% ## this needs to be updated every FY
    left_join(working_days,by=c('month')) %>% 
    #mutate(scaled_UDA_delivery = UDA_delivery * 12) %>%
    mutate(perc_UDA_deliverd =100* (UDA_delivery /(contracted_UDAs*(`no workdays`/`total workdays`)))) %>%
    mutate(perc_UDA_deliverd = round(perc_UDA_deliverd, digits = 0)) %>% 
    add_row(month = seq(as.Date("2016-04-01"), as.Date("2023-03-01"), lubridate::month(1))) %>% # need to add every FY
    mutate(financial_year = case_when(month >= as.Date("2016-04-01") & month < as.Date("2017-04-01") ~ "2016/17",
                                      month >= as.Date("2017-04-01") & month < as.Date("2018-04-01") ~ "2017/18",
                                      month >= as.Date("2018-04-01") & month < as.Date("2019-04-01") ~ "2018/19",
                                      month >= as.Date("2019-04-01") & month < as.Date("2020-04-01") ~ "2019/20",
                                      month >= as.Date("2020-04-01") & month < as.Date("2021-04-01") ~ "2020/21",
                                      month >= as.Date("2021-04-01") & month < as.Date("2022-04-01") ~ "2021/22",
                                      month >= as.Date("2022-04-01") & month < as.Date("2023-04-01") ~ "2022/23",
                                      month >= as.Date("2023-04-01") & month < as.Date("2024-04-01") ~ "2023/24",
                                      month >= as.Date("2024-04-01") & month < as.Date("2025-04-01") ~ "2024/25")) %>%
    #join this FY data with historical data
    left_join(historic_data, by = "financial_year") %>%
    mutate(perc_UDA_delivered = if_else(!is.na(perc_UDA_deliverd.x), perc_UDA_deliverd.x, perc_UDA_deliverd.y)) 
  
  data <- data_try %>%
    mutate(year_type = if_else(financial_year == "2023/24", "Current Financial Year", 
                               "Previous Financial Years (Averages)")) %>% 
    # mutate(year_type = if_else(financial_year == max(data$financial_year), "Current Financial Year", 
    #                            "Previous Financial Years (Averages)")) %>%
    #filter April data for previous FY and all current FY data
    filter((substr(month, 6, 7) == "04" & substr(month, 9, 10) == "01")| year_type == "Current Financial Year")
  
  data$year_type <- factor(data$year_type, levels = c("Previous Financial Years (Averages)",
                                                      "Current Financial Year"))
  
    

  data<- data %>% 
    mutate(line_for_100 = 100)
  
    ggplot() +
    geom_line(data = data, aes(x = month,
                               y = perc_UDA_delivered),
              colour = "black") +
   #   geom_line(data = data, aes(x = month,
   #                              y = perc_standardised_wd),
   #             colour = "red")+
      
      geom_line(data = data, aes(x = month,
                                 y = line_for_100),
                colour = "blue")+
      
      geom_point(#data = filter(data, year_type == "Current Financial Year"),
      data = data,
      aes(x = month,
          y = perc_UDA_delivered),
      colour = "steelblue") +
    geom_text(data = filter(data, year_type == "Previous Financial Years (Averages)"),
              aes(x = month + 120,
                  y = perc_UDA_delivered - 4,
                  label = financial_year),
              size = 3) +
    geom_text(data = filter(data, year_type == "Previous Financial Years (Averages)"),
              aes(x = month + 120,
                  y = perc_UDA_delivered + 4,
                  label = paste0(round(perc_UDA_delivered), "%")),
              size = 3) +
    geom_text(data = filter(data, year_type == "Current Financial Year"),
              aes(x = month,
                  y = perc_UDA_delivered + 4,
                  label = paste0(round(perc_UDA_delivered), "%")),
              size = 3) +
    facet_wrap(vars(year_type),
               scales = "free_x") +
    theme_bw() +
    #scale_x_date(breaks = scales::breaks_width(1)) +
    scale_y_continuous(limits = c(0, max(c(data$perc_UDA_delivered, 95), na.rm = T) + 5),
                       breaks = seq(0, max(c(data$perc_UDA_delivered, 95), na.rm = T) + 5, 10)#,
                       #labels = scales::percent_format(accuracy = 1)
    ) +
    labs(title = "Monthly percentage of usual annual contracted UDAs \nstandardised by working days",
         x = "Time period",
         y = "Percentage of contracted UDAs delivered",
         subtitle = subtitle) +
    theme(axis.text.x = element_text(angle = 90, vjust=-0.0001
    )) 
  
}
```



```{r UOA activity data - with historic data}
plot_historic_UOA_delivery_wd <- function(data = UOA_calendar_data,
                                                           level = "National",
                                                           region_STP_name = NULL){
  
  
  #filter for STP or region in need
  if(level == "Regional"){
    data <- data %>%
      filter(region_name == region_STP_name )
    
    subtitle <- region_STP_name
    
  }else if(level == "STP"){
    data <- data %>%
      filter(commissioner_name == region_STP_name)
    
    
    subtitle <- region_STP_name
    
  }else{
    subtitle <- "England"
  }
  
  #prepare historical data
  historic_data <- data %>%
    select(month, contract_number, commissioner_name, region_name,
           annual_contracted_UOA, UOA_delivered)

  ##create a new field as financial year and then calculate full year UDA delivered, contracted UDA and percentage of UDA delivered
  historic_data <- historic_data  %>%
    mutate(financial_year = case_when(month >= as.Date("2016-04-01") & month < as.Date("2017-04-01") ~ "2016/17",
                                      month >= as.Date("2017-04-01") & month < as.Date("2018-04-01") ~ "2017/18",
                                      month >= as.Date("2018-04-01") & month < as.Date("2019-04-01") ~ "2018/19",
                                      month >= as.Date("2019-04-01") & month < as.Date("2020-04-01") ~ "2019/20",
                                      month >= as.Date("2020-04-01") & month < as.Date("2021-04-01") ~ "2020/21",
                                      month >= as.Date("2021-04-01") & month < as.Date("2022-04-01") ~ "2021/22",
                                      month >= as.Date("2022-04-01") & month < as.Date("2023-04-01") ~ "2022/23",
                                      month >= as.Date("2023-04-01") & month < as.Date("2024-04-01") ~ "2023/24",
                                      month >= as.Date("2024-04-01") & month < as.Date("2025-04-01") ~ "2024/25")) %>%
    group_by(financial_year) %>%
    summarise(full_year_UOA_delivery = sum(UOA_delivered, na.rm = TRUE),
              full_year_contracted_UOAs = sum(annual_contracted_UOA, na.rm = TRUE) / 12) %>%
    mutate(perc_UOA_delivered = full_year_UOA_delivery * 100 / full_year_contracted_UOAs)
  
  
  
  #get current FY data ready
  data_try <- data %>%
    group_by(month) %>%
    summarise(UOA_delivery = sum(UOA_delivered, na.rm = TRUE),
              contracted_UOAs = sum(annual_contracted_UOA, na.rm = TRUE)) %>%
    filter(month >= as.Date ("2023-04-01")) %>% ## this needs to be updated every FY
    left_join(working_days,by=c('month')) %>% 
   # mutate(scaled_UOA_delivery = UOA_delivery * 12) %>%
    mutate(perc_UOA_delivered =100* (UOA_delivery / (contracted_UOAs*(`no workdays`/`total workdays`)))) %>%
    mutate(perc_UOA_delivered = round(perc_UOA_delivered, digits = 0))%>% 
    add_row(month = seq(as.Date("2016-04-01"), as.Date("2023-03-01"), lubridate::month(1))) %>%
    mutate(financial_year = case_when(month >= as.Date("2016-04-01") & month < as.Date("2017-04-01") ~ "2016/17",
                                      month >= as.Date("2017-04-01") & month < as.Date("2018-04-01") ~ "2017/18",
                                      month >= as.Date("2018-04-01") & month < as.Date("2019-04-01") ~ "2018/19",
                                      month >= as.Date("2019-04-01") & month < as.Date("2020-04-01") ~ "2019/20",
                                      month >= as.Date("2020-04-01") & month < as.Date("2021-04-01") ~ "2020/21",
                                      month >= as.Date("2021-04-01") & month < as.Date("2022-04-01") ~ "2021/22",
                                      month >= as.Date("2022-04-01") & month < as.Date("2023-04-01") ~ "2022/23",
                                      month >= as.Date("2023-04-01") & month < as.Date("2024-04-01") ~ "2023/24",
                                      month >= as.Date("2024-04-01") & month < as.Date("2025-04-01") ~ "2024/25")) %>%
    #join this FY data with historical data
    left_join(historic_data, by = "financial_year") %>%
    mutate(perc_UOA_delivered = if_else(!is.na(perc_UOA_delivered.x), perc_UOA_delivered.x, perc_UOA_delivered.y)) 
  
  data <- data_try %>%
    mutate(year_type = if_else(financial_year == "2023/24", "Current Financial Year", 
                               "Previous Financial Years (Averages)")) %>% 
    # mutate(year_type = if_else(financial_year == max(data$financial_year), "Current Financial Year", 
    #                            "Previous Financial Years (Averages)")) %>%
    #filter April data for previous FY and all current FY data
    filter((substr(month, 6, 7) == "04" & substr(month, 9, 10) == "01")| year_type == "Current Financial Year")
  
  data$year_type <- factor(data$year_type, levels = c("Previous Financial Years (Averages)",
                                                      "Current Financial Year"))
  

      

  data<- data %>% 
    mutate(line_for_100 = 100)
  
    ggplot() +
    geom_line(data = data, aes(x = month,
                               y = perc_UOA_delivered),
              colour = "black") + 
    #  geom_line(data = data, aes(x = month,
     #                            y = perc_standardised_wd),
     #           colour = "red")+ 
      geom_line(data = data, aes(x = month,
                                 y = line_for_100),
                colour = "blue")+
      geom_point(#data = filter(data, year_type == "Current Financial Year"),
      data = data,
      aes(x = month,
          y = perc_UOA_delivered),
      colour = "steelblue") +
    geom_text(data = filter(data, year_type == "Previous Financial Years (Averages)"),
              aes(x = month + 120,
                  y = perc_UOA_delivered - 4,
                  label = financial_year),
              size = 3) +
    geom_text(data = filter(data, year_type == "Previous Financial Years (Averages)"),
              aes(x = month + 120,
                  y = perc_UOA_delivered + 4,
                  label = paste0(round(perc_UOA_delivered), "%")),
              size = 3) +
    geom_text(data = filter(data, year_type == "Current Financial Year"),
              aes(x = month,
                  y = perc_UOA_delivered + 4,
                  label = paste0(round(perc_UOA_delivered), "%")),
              size = 3) +
    facet_wrap(vars(year_type),
               scales = "free_x") +
    theme_bw() +
    #scale_x_date(breaks = scales::breaks_width(1)) +
    scale_y_continuous(limits = c(0, max(c(data$perc_UOA_delivered, 95), na.rm = T) + 5),
                       breaks = seq(0, max(c(data$perc_UOA_delivered, 95), na.rm = T) + 5, 10)#,
                       #labels = scales::percent_format(accuracy = 1)
    ) +
    labs(title = "Monthly percentage of usual annual contracted UOAs \nstandardised by working days",
         x = "Time period",
         y = "Percentage of contracted UOAs delivered",
         subtitle = subtitle) +
    theme(axis.text.x = element_text(angle = 90, vjust=-0.0001
    )) 
}
```


``` {r YTD UDA/UDA delivered}
plot_YTD_UDA_UOA_delivery <- function(data = UDA_calendar_data, 
                                      UDAorUOA = "UDA",
                                      level = "National",
                                      region_STP_name = NULL,
                                      plotChart = TRUE, 
                                      all_regions_and_STPs = FALSE){

  
  #filter for STP or region in need
  if(level == "Regional"){
    data <- data %>%
      filter(region_name == region_STP_name )
    subtitle <- region_STP_name
  }else if(level == "STP"){
    data <- data %>%
      filter(commissioner_name == region_STP_name)
    subtitle <- region_STP_name
  }else{
    subtitle <- "England"
  }
  
  if(UDAorUOA == "UDA"){
    #get data into the right format for UDA
    data <- get_delivery_data(data, UDAorUOA = "UDA", all_regions_and_STPs = all_regions_and_STPs)
    title <- "YTD UDA delivery across all contracts* against annual contracted UDAs (millions)"
    ylab <- "YTD UDA delivery (millions)"
    #captionTitle <- "*These are treatment months..."
    lineCol <- "#CC79A7"
    labels <- c("Expected YTD delivery to meet contracted UDAs \nif delivery were equal across the financial year", 
                "Total annual contracted UDAs", 
                "Actual YTD delivery")
  }else{
    #get data into the right format for UOA
    data <- get_delivery_data(data, UDAorUOA = "UOA", all_regions_and_STPs = all_regions_and_STPs)
    title <- "YTD UOA delivery across all contracts* against annual contracted UOAs (millions)"
    ylab <- "YTD UOA delivery (millions)"
    #captionTitle <- "*These are treatment months..."
    lineCol <- "steelblue"
    labels <- c("Expected YTD delivery to meet contracted UOAs \nif delivery were equal across the financial year",
            "Total annual contracted UOAs", 
            "Actual YTD delivery")
  }
  
  # extract previous financial year
  historic_data <- data %>% 
    filter(month >= as.Date("2022-04-01") & month <= as.Date("2023-03-01")) %>% ##must be updated each financial year
    mutate(YTD_delivery = cumsum(monthly_UDA_UOAs_delivered))
  
  data <- data %>%
    filter(month > as.Date("2023-03-01")) %>% ##must be updated each financial year
    mutate(YTD_delivery = cumsum(monthly_UDA_UOAs_delivered))
  
  #get the mean annual contracted UDAs across the months
  ##mean_annual_contracted_UDA_UOAs <- mean(data$annual_contracted_UDA_UOA)
  
  ## this has been chaged to latest contracted UDA / UOA on November 2023 by ME after checking with CK
  # add latest contracted UDA/UOA as a column to use in plot
  # also add for previous financial year
  # output both as a value to be used in later calculations
  data$latest_annual_contracted_UDA_UOAs<- dplyr::last(data$annual_contracted_UDA_UOA)
  mean_annual_contracted_UDA_UOAs<- dplyr::last(data$annual_contracted_UDA_UOA)
  historic_data$latest_annual_contracted_UDA_UOAs<- dplyr::last(historic_data$annual_contracted_UDA_UOA)
  mean_annual_contracted_UDA_UOAs_historic<- dplyr::last(historic_data$annual_contracted_UDA_UOA)
  
  #add in blanks for the rest of the year
  if(all_regions_and_STPs == FALSE & nrow(data) < 12){
  
    if(!(as.Date("2023-05-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-05-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2023-06-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-06-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2023-07-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-07-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2023-08-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-08-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2023-09-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-09-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2023-10-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-10-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2023-11-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-11-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2023-12-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2023-12-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2024-01-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2024-01-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2024-02-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2024-02-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  
    if(!(as.Date("2024-03-01") %in% data$month)){
      data <- data %>% add_row(month = as.Date("2024-03-01"), 
                              latest_annual_contracted_UDA_UOAs = mean_annual_contracted_UDA_UOAs)
    }
  }
  

  #add column for expected delivery
  data_to_print <- data %>%
    mutate(expected_delivery = seq(mean_annual_contracted_UDA_UOAs/12, mean_annual_contracted_UDA_UOAs, mean_annual_contracted_UDA_UOAs/12)) %>%
    select(month, YTD_delivery, expected_delivery, latest_annual_contracted_UDA_UOAs)
  
  #pivot for plotting
  data <- data_to_print %>%
    pivot_longer(cols = c("YTD_delivery", "expected_delivery", "latest_annual_contracted_UDA_UOAs"), 
               names_to = "measure", values_to = "value")

  # format historic data to match current year
  historic_data_to_print <- historic_data %>% 
    mutate(expected_delivery = seq(mean_annual_contracted_UDA_UOAs_historic/12, mean_annual_contracted_UDA_UOAs_historic, mean_annual_contracted_UDA_UOAs_historic/12)) %>%
    select(month, YTD_delivery, expected_delivery, latest_annual_contracted_UDA_UOAs)

  historic_data <- historic_data_to_print %>% 
    pivot_longer(cols = c("YTD_delivery", "expected_delivery", "latest_annual_contracted_UDA_UOAs"), 
                names_to = "measure", values_to = "value")

  # bind current and previous financial years
  # pivot so latest contracted UDA or UOAs is a separate column
  data <- rbind(historic_data, data) %>% 
    mutate(year_type = ifelse(month > max(historic_data$month), "Current Financial Year", "Previous Financial Year"))

  data$year_type <- factor(data$year_type, levels = c("Previous Financial Year",
                                                      "Current Financial Year"))  
  
  if(plotChart == TRUE){
    #plot code
    p <- ggplot(data) +
        theme_bw() +
        geom_line(aes(x = month,
                      y = value/1000000,
                      colour = measure,
                      linetype = measure),
                  size = 1) +
        geom_point(aes(x = month,
                      y = value/1000000,
                      colour = measure#,
                      #shape = measure
        )
        ) +
        #geom_hline(yintercept = latest_annual_contracted_UDA_UOAs/1000000,
        #           linetype = "dashed") +
        scale_x_date(date_breaks = "1 month",
                    date_labels = "%b-%y") +
        # scale_y_continuous(limits = c(0, max(c(data$perc_UDA_UOA_delivered, 95), na.rm = T) + 5),
        #                    breaks = seq(0, max(c(data$perc_UDA_UOA_delivered, 95), na.rm = T) + 5, 10)) +
        labs(title = title,
            x = "Month",
            y = ylab,
            subtitle = subtitle,
            #caption = captionTitle,
            colour = "",
            linetype = ""#,
            #shape = ""
        ) +
        theme(axis.text.x = element_text(angle = 90, vjust=-0.0001
        )) +
        facet_wrap(vars(year_type),
                  scales = "free_x") +
        #annotate(geom = "text",
        #         x = as.Date("2023-05-01") + lubridate::weeks(2),
        #         y = mean_annual_contracted_UDA_UOAs/1000000 - mean_annual_contracted_UDA_UOAs/16000000,
        #         label = "Total annual contracted UDAs",
        #         size = 3) +
        scale_colour_manual(values = c("grey", "black", lineCol), labels = labels) +
        scale_linetype_manual(values = c("dashed", "dashed", "solid"), labels = labels,
                              guide = "none") +
        # scale_shape_manual(values = c("4", "1"), labels = c("Expected YTD delivery to meet contracted UDAs \nif delivery were equal across the year",
        #                                                                 "Actual YTD delivery")) +
        theme(legend.position="bottom")
    
    
    p
    
  }else{
    #if want a data table instead
    data_to_print <- data_to_print %>%
      rename(`Calendar month` = month,
             `YTD delivery` = YTD_delivery,
             `Required YTD delivery in order to meet contracted UDAs` = expected_delivery)
    
    data_to_print$`Calendar month` <- format(as.Date(data_to_print$`Calendar month`), "%Y-%m")
  }
}
```

```{r}
Table_YTD_UDA_UOA_delivery <- function(data = UDA_calendar_data, 
                                      UDAorUOA = "UDA",
                                      level = "National",
                                      all_regions_and_STPs = FALSE){

  

  if(UDAorUOA == "UDA"){
    #get data into the right format for UDA
    data <- get_delivery_data(data, UDAorUOA = "UDA", all_regions_and_STPs = all_regions_and_STPs)
    
  }else{
    #get data into the right format for UOA
    data <- get_delivery_data(data, UDAorUOA = "UOA", all_regions_and_STPs = all_regions_and_STPs)
   
  }
  
  data$`Calendar month` <- format(as.Date(data$`month`), "%Y-%m")
  
  if(level == "Regional"){
    #calculate YTD group by month and region
    data <- data %>%
      filter(month >= as.Date ("2020-04-01"))%>%
      group_by(`Calendar month`,region_name) %>%
      summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered))%>%
      group_by(region_name) %>%
      dplyr::mutate(YTD_delivery = cumsum(monthly_UDA_UOAs_delivered))%>%
       select(`Calendar month`,YTD_delivery)
    
  }else if(level == "STP"){
   #calculate YTD group by month and ICB
    data <- data %>%
      filter(month >= as.Date ("2020-04-01"))%>%
      group_by(`Calendar month`,commissioner_name) %>%
      summarise(monthly_UDA_UOAs_delivered = sum(monthly_UDA_UOAs_delivered))%>%
      group_by(commissioner_name) %>%
      dplyr::mutate(YTD_delivery = cumsum(monthly_UDA_UOAs_delivered))%>%
       select(`Calendar month`,YTD_delivery)
   
  }else{
     data <- data %>%
       arrange(`Calendar month`)%>%
    dplyr::mutate(YTD_delivery = cumsum(monthly_UDA_UOAs_delivered))%>%
       select(`Calendar month`,YTD_delivery)
  }
  

  
  
}
  
```

```{r banded_CoT}
plot_banded_CoT <- function(data = UDA_calendar_data, 
                            level = "National", 
                            region_STP_name = NULL, 
                            plotChart = TRUE, 
                            all_regions_and_STPs = FALSE, 
                            asIndex = FALSE){
  #avoid standard form on axes
  options(scipen = 100)
  
  #toggle subtitle
  if(level == "Regional"){
    #filter for region or STP
    data <- data %>% 
      filter(region_name == region_STP_name )
    subtitle <- region_STP_name 
  }else if(level == "STP"){
    #filter for region or STP
    data <- data %>% 
      filter(commissioner_name == region_STP_name )
    subtitle <- region_STP_name
  }else{
    subtitle <- "England"
    data <- data
  }
  
  #get data into the right format
  data_to_print <- get_banded_COTs_data(data, all_regions_and_STPs = all_regions_and_STPs)
  data <- reshape2::melt(data_to_print, id.vars = "month")
  data <- data %>%
    mutate(month = as.Date(month)) %>%
    rename(band = variable, CoTs = value)
  
  #set everything as index of Feb 2020 and standardise for working days
  # or standardise for working days only
  if(asIndex == TRUE){
    
    data <- data %>%
      left_join(working_days,by=c('month')) %>% 
      mutate(standardised_CoTs = CoTs *(`no workdays`/`total workdays`), 
             month_number = substr(month, 6, 7), 
             year_number = substr(month, 1, 4))
    
    dataFeb2020 <- data %>% 
      filter(year_number == "2020" & month_number == "02") %>% 
      select(month_number, 
             band, 
             CoTs_feb2020 = CoTs)
    
    data <- data %>% 
      left_join(dataFeb2020, by = c("band")) %>% 
      mutate(CoTs = CoTs * 100 / CoTs_feb2020)
    
    title <- "Banded Courses of Treatment as a Percentage of February 2020 Delivery"
    ylab <- "Percentage of 2019 FP17* forms submitted"
    
    }else{
      data <- data %>% left_join(working_days,by=c('month')) %>% 
        mutate(standardised_CoTs = CoTs *(`no workdays`/`total workdays`))
      
      title <- "Banded Courses of Treatment"
      ylab <- "Number of FP17* forms submitted"
    }
  
  if(plotChart == TRUE){
    
    #plot code
    ggplot(data) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_line(aes(x = month,
                    y = CoTs,
                    colour = band),
                size = 1) +
      geom_point(aes(x = month,
                     y = CoTs,
                     colour = band),
                 size = 1) +
      scale_x_date(date_breaks = "1 month",
                   date_labels = "%b-%y") +
      scale_colour_manual(labels = c("Band 1", "Band 2", "Band 3", "Other", "Urgent"),
                          values = get_colour_palette()#c("coral3",
                          # "orange",
                          # "yellow3",
                          # "green",
                          # "blue")
      ) +
      scale_y_continuous(breaks = scales::breaks_pretty(),
                         labels = function(x) format(x, big.mark = ",", scientific = FALSE)) +
      labs(title = title,
           x = "Month",
           y = ylab,
           colour = "Band",
           subtitle = subtitle)
    
  }else{
    data_to_print %>%
      mutate(month = as.Date(month)) %>%
      rename(Month = month,
             `Region Name` = region_name,
             `Commissioner Name` = commissioner_name,
             `Band 1` = band1,
             `Band 2` = band2,
             `Band 3` = band3,
             `Other` = other,
             `Urgent` = urgent)
  }
}
```

```{r 111 dental}

plot_111_referrals <- function(data = dental_data_111,
                               plotChart = TRUE){
  #calculate case volume for each month
  data <- data %>% 
    mutate(month = as.Date(month)) %>%
    group_by(month) %>%
    summarise(monthly_case_volume = sum(monthly_case_volume))
  
  #plot code
  p <- ggplot(data) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90)) +
    geom_line(aes(x = month, 
                  y = monthly_case_volume), 
              colour = "steelblue", 
              size = 1) +
    scale_x_date(date_breaks = "1 month", 
                 date_labels = "%b-%y") +
    scale_y_continuous(breaks = seq(0, 
                                    max(data$monthly_case_volume, na.rm = T) + 10000,
                                    10000),
                       limits = c(0, max(data$monthly_case_volume))) +
    labs(title = "111 call volume recommended towards dental services", 
         x = "Month",
         y = "Call volume", 
         subtitle = "England"#,
         #caption = "*services include: "
    ) #+
  # annotate(geom = "text", 
  #          x = data$month, 
  #          y = data$monthly_case_volume + 1, 
  #          label = data$monthly_case_volume, 
  #          size = 3) 
  
  if(plotChart == TRUE){
    p
  }else{
    data
  }
  
}


```

```{r  breakdown_111_referrals}
plot_breakdown_111_referrals <- function(data = dental_data_111,
                                         plotChart = TRUE){
  
  data <- data %>% 
    mutate(disposition_text = if_else(disposition_text == "Attend Emergency Dental Treatment Centre within 4",
                                      "Attend Emergency Dental Treatment Centre within 4hrs",
                                      disposition_text)) %>%
    mutate(month = as.Date(month)) 
  
  #get lines in the right order
  data$disposition_text <- factor(data$disposition_text,
                                  levels = c("Refer to Dental Treatment Centre within 1 hour",
                                             "Refer to Dental Treatment Centre within 4 hours",
                                             "To Speak to a Dental Service within 1 hour",
                                             "To Speak to a Dental Service within 2 hours",
                                             "Speak to a Dental Service within 2 hours",
                                             "To Speak to a Dental Service within 6 hours",
                                             "To Speak to a Dental Service within 12 hours",
                                             "To Speak to a Dental Service within 24 hours",
                                             "To Speak to a Dental Practice within 7 days",
                                             "Contact Orthodontist next working day"
                                  ))
  
  #plot code
  p <- ggplot(data) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90)) +
    geom_line(aes(x = month, 
                  y = monthly_case_volume,
                  colour = str_wrap(disposition_text, 35)), 
              size = 1) +
    scale_x_date(date_breaks = "1 month", 
                 date_labels = "%b-%y") +
    # scale_y_continuous(breaks = seq(47000, 
    #                                 max(data$monthly_case_volume, na.rm = T) + 10000,
    #                                 10000)) +
    labs(title = "111 call volume recommended towards dental services", 
         x = "Month",
         y = "Call volume", 
         subtitle = "England",
         colour = "Disposition"#,
         #caption = "*services include: "
    ) #+
  # annotate(geom = "text", 
  #          x = data$month, 
  #          y = data$monthly_case_volume + 1, 
  #          label = data$monthly_case_volume, 
  #          size = 3) 
  
  if(plotChart == TRUE){
    p
  }else{
    data %>%
      select(`Month` = month,
             `Disposition` = disposition_text,
             `Monthly case volume` = monthly_case_volume)
  }
  
}
```

