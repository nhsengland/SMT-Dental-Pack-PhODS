---
title: "functions for NPP activity monitoring"
---

```{r libraries}
library(tidyverse)
library(odbc)
library(DBI)
```

```{r pull NCDR data}
sql <- "SELECT 
  [YEAR_MONTH]
  ,[COMMISSIONER_CODE]
  ,SUM([NEW_PATIENT_TARIFF_AMOUNT]) AS NPPUDAs
  ,SUM([BAND1_ADULT_COUNT]) + SUM([BAND1_CHILD_COUNT]) + SUM([BAND23_ADULT_COUNT]) + SUM([BAND23_CHILD_COUNT]) AS TotalNPP
  FROM [NHSE_Sandbox_PrimaryCareNHSContracts].[Dental].[Calendar_NPP_Eligible_Activity]
  WHERE EXCLUDE_FROM_NPT = 'N' AND YEAR_MONTH > '2024-02-01'
  GROUP BY COMMISSIONER_CODE, YEAR_MONTH"

con <- dbConnect(odbc::odbc(), "NCDR")

data <- dbGetQuery(con, sql)

dbDisconnect(con)
```

```{r load fixed data}
# read in monthly average delivery pre-NPP
# saved to N drive for time being, as it is fixed could upload to NCDR
monthly_delivered_pre <- read.csv("N:/_Everyone/Primary Care Group/SMT_Dental Calendar data format/BSA Calendar data/NPP/national_pre_intro.csv") %>% 
  mutate(total = BAND1_ADULT_COUNT + BAND1_CHILD_COUNT + BAND23_ADULT_COUNT + BAND23_CHILD_COUNT,
         financial_year = ifelse(TREATMENT_MONTH <= "202402",
                                 "2023/24", "2024/25"), 
         group = ifelse(TREATMENT_MONTH <= "202402",
                        "Pre NPP launch (2023/24)", "Post NPP launch - unpaid (2024/25)"),
         YEAR_MONTH = as.Date(paste(substr(TREATMENT_MONTH, 1, 4), 
                                    substr(TREATMENT_MONTH, 5, 6), 
                                    "01", sep = "-"))) %>% 
  select(YEAR_MONTH, total, financial_year, group)
```

```{r calculate figures}
# calculate monthly paid delivered so far
monthly_delivered_paid <- data %>% 
  group_by(YEAR_MONTH) %>% 
  summarise(total = sum(TotalNPP, na.rm = TRUE)) %>% 
  mutate(financial_year = "2024/25", 
         group = "Post NPP launch - paid (2024/25)")

# combine pre and post intro
monthly_delivered <- rbind(monthly_delivered_pre, monthly_delivered_paid) %>% 
  mutate(month_name = month.name[month(YEAR_MONTH)], 
         month_name = factor(month_name, 
                             levels = c("March", "April", "May", "June", "July", "August", 
                                        "September", "October", "November", "December", "January", "February")),
         group = factor(group, 
                        levels = c("Pre NPP launch (2023/24)", "Post NPP launch - unpaid (2024/25)", "Post NPP launch - paid (2024/25)")))
```

```{r plot chart}
plot_npp_activity_monitoring <- function(){
  plt <- ggplot(monthly_delivered, 
                aes(x = financial_year,
                    y = total, 
                    fill = group)) + 
    geom_bar(stat = "identity", position = "stack") + 
    facet_wrap(~month_name, ncol=12, strip.position = "bottom") + 
    xlab("Month") + 
    ylab("Completed courses of treatment") + 
    scale_y_continuous(labels = scales::comma) + 
    scale_fill_manual(values = c("#003087", "#E5C9D9", "#AE2573"),
                      labels = c("Pre NPP launch (2023/24)",
                                 "Post NPP launch - unpaid (2024/25)",
                                 "Post NPP launch - paid (2024/25)")) + 
    theme(panel.border = element_blank(),
          panel.background = element_blank(), 
          strip.background = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          legend.position = "bottom",
          legend.title = element_blank())
  
  plt
}
```
